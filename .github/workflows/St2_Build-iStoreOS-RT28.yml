name: ðŸ’¿ St2_Build-iStoreOS-RT28

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      openwrt_board:
        description: "è¯·é€‰æ‹©è®¾å¤‡åž‹å·"
        required: true
        default: "h96-max-m2"
        type: choice
        options:
          - h96-max-m2
      openwrt_kernel:
        description: "è¯·é€‰æ‹©å†…æ ¸ç‰ˆæœ¬ï¼ˆè‹¥æœªåŒ¹é…åˆ™è‡ªåŠ¨ï¼‰"
        required: true
        default: "6.6.y"
        type: choice
        options:
          - 5.10.y
          - 5.15.y
          - 6.1.y
          - 6.6.y
          - 6.12.y
      openwrt_rootfs:
        description: "è¯·é€‰æ‹©Rootfsé€šç”¨åº•åŒ…ï¼ˆç¡®ä¿step1æœ‰ç”Ÿæˆï¼‰"
        required: true
        default: "RELEASE"
        type: choice
        options:
          - RELEASE
      network_settings:
        description: "è¯·é€‰æ‹©åˆå§‹ç½‘ç»œé…ç½®ï¼ˆç¡®ä¿step1æœ‰ç”Ÿæˆï¼‰"
        required: true
        default: "dhcp"
        type: choice
        options:
          - static
          - dhcp

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: â¬ ä¸‹è½½ rootfs.tar.gz
        run: |
          echo "ðŸ“¦ æ­£åœ¨ä¸‹è½½é¢„æž„å»º rootfs"
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/${{ github.actor }}/iStoreOS-Actions/releases/download/iStoreOS-24.10-${{ inputs.openwrt_rootfs }}-${{ inputs.network_settings }}/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: ðŸ” æŸ¥æ‰¾rootfs.tar.gzæ‰€åœ¨è·¯å¾„
        id: find_rootfs
        run: |
          ROOTFS_FILE=$(find bin/targets/armsr/armv8/ -type f -name "*rootfs.tar.gz" | head -n1)
          echo "âœ… Found: $ROOTFS_FILE"
          if [ ! -f "$ROOTFS_FILE" ]; then
            echo "âŒ æ‰¾ä¸åˆ° rootfs.tar.gz æ–‡ä»¶"
            exit 1
          fi
          echo "file=$ROOTFS_FILE" >> $GITHUB_OUTPUT

      - name: âš™ï¸ æ·»åŠ RT28é…ç½®åˆ°æ‰“åŒ…çŽ¯å¢ƒ
        run: |
          echo "æ·»åŠ RT28é…ç½®åˆ°æ‰“åŒ…çŽ¯å¢ƒ..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç»“æž„
          mkdir -p custom_files/etc/board.d
          mkdir -p custom_files/etc/config
          
          # åˆ›å»ºRT28 LEDé…ç½®æ–‡ä»¶
          cat > custom_files/etc/board.d/01_leds_rt28 << 'EOF'
          . /lib/functions.sh

          set_led_config() {
              case "$(board_name)" in
                  h96-max-m2)
                      # RT28ä¸“ç”¨LEDé…ç½®
                      ucidef_set_led_netdev "wlan2g" "WiFi 2.4GHz" "link_blue" "radio0"
                      ucidef_set_led_netdev "wlan5g" "WiFi 5GHz" "link_green" "radio1"
                      ;;
              esac
          }

          boot_hook_add preinit_main set_led_config
          EOF

          # åˆ›å»ºRT28 networké…ç½®æ–‡ä»¶
          cat > custom_files/etc/config/network << 'EOF'
          config interface 'loopback'
              option ifname 'lo'
              option proto 'static'
              option ipaddr '127.0.0.1'
              option netmask '255.0.0.0'

          config globals 'globals'
              option ula_prefix 'fd00:ab:cd::/48'

          config interface 'lan'
              option type 'bridge'
              option ifname 'eth0.1'
              option proto 'static'
              option ipaddr '192.168.8.1'
              option netmask '255.255.255.0'
              option ip6assign '60'

          config interface 'wan'
              option ifname 'eth0.2'
              option proto 'dhcp'

          config switch
              option name 'switch0'
              option reset '1'
              option enable_vlan '1'

          config switch_vlan
              option device 'switch0'
              option vlan '1'
              option ports '0 1 2 7'

          config switch_vlan
              option device 'switch0'
              option vlan '2'
              option ports '3 7'
          EOF

          # è®¾ç½®æ‰§è¡Œæƒé™
          chmod +x custom_files/etc/board.d/01_leds_rt28

      - name: ðŸ§± æ‰“åŒ…iStoreOSå›ºä»¶ï¼ˆåŒ…å«RT28é…ç½®ï¼‰
        uses: sy3tem/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: ${{ steps.find_rootfs.outputs.file }}
          openwrt_board: ${{ inputs.openwrt_board }}
          openwrt_kernel: ${{ inputs.openwrt_kernel }}
          auto_kernel: true
          kernel_repo: ophub/kernel
          kernel_usage: stable
          builder_name: kwonelee
          custom_files: ./custom_files

      - name: ðŸ“œ è°ƒæ•´.img.gz æ–‡ä»¶å
        id: rename
        run: |
          for FILE in ${{ env.PACKAGED_OUTPUTPATH }}/*.img.gz; do
            echo "Processing file: $FILE"
            FILENAME=$(basename "$FILE")
            NEW_FILENAME=$(echo "$FILENAME" | sed 's/openwrt/istoreos_24.10.2/g' | sed 's/h96-max-m2/rt28-test/g')
            if [ "$FILENAME" != "$NEW_FILENAME" ]; then
              mv "$FILE" "${{ env.PACKAGED_OUTPUTPATH }}/$NEW_FILENAME"
              echo "Renamed $FILENAME to $NEW_FILENAME"
            else
              echo "No need to rename $FILENAME"
            fi
          done

      - name: ðŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: iStoreOS-24.10-RT28-TEST-${{ inputs.openwrt_rootfs }}-${{ inputs.network_settings }}
          body: |
            ðŸ“Œ ç‰ˆæœ¬ï¼š iStoreOS-24.10.2-RELEASE (æµ‹è¯•ç‰ˆ)
            ðŸ“Ÿ åŸºç¡€è®¾å¤‡ï¼š h96-max-m2 (é€‚é…RT28ç½‘ç»œ/LED)
            ðŸ·ï¸ å¹³å°ï¼š armsr/armv8
            ðŸ§  å†…æ ¸ï¼š ${{ inputs.openwrt_kernel }}
            
            ðŸŒ RT28ç½‘ç»œé…ç½®ï¼š
              - LAN: eth0.1 (IP: 192.168.8.1)
              - WAN: eth0.2 (DHCP)
              - äº¤æ¢æœº: VLAN1 (LAN): 0,1,2,7; VLAN2 (WAN): 3,7
            
            ðŸ’¡ RT28 LEDé…ç½®ï¼š
              - WiFi 2.4GHz: link_blue (radio0)
              - WiFi 5GHz: link_green (radio1)
            
            âš ï¸ æ³¨æ„ï¼šæ­¤ä¸ºæµ‹è¯•ç‰ˆæœ¬ï¼ŒåŸºäºŽh96-max-m2è®¾å¤‡é€‚é…RT28çš„ç½‘ç»œå’ŒLEDé…ç½®
            
            ðŸ‘¤ ç”¨æˆ·åï¼š root
            ðŸ”’ å¯†ç ï¼š æ— 
            ðŸŒ ç®¡ç†åœ°å€ï¼š 192.168.8.1
          files: |
            ${{ env.PACKAGED_OUTPUTPATH }}/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
