name: 💿 St2_Build-iStoreOS-RT28

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      openwrt_board:
        description: "请选择设备型号"
        required: true
        default: "h96-max-m2"
        type: choice
        options:
          - h96-max-m2
      openwrt_kernel:
        description: "请选择内核版本（若未匹配则自动）"
        required: true
        default: "6.6.y"
        type: choice
        options:
          - 5.10.y
          - 5.15.y
          - 6.1.y
          - 6.6.y
          - 6.12.y
      openwrt_rootfs:
        description: "请选择Rootfs通用底包（确保step1有生成）"
        required: true
        default: "RELEASE"
        type: choice
        options:
          - RELEASE
      network_settings:
        description: "请选择初始网络配置（确保step1有生成）"
        required: true
        default: "dhcp"
        type: choice
        options:
          - static
          - dhcp

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: ⏬ 下载 rootfs.tar.gz
        run: |
          echo "📦 正在下载预构建 rootfs"
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/${{ github.actor }}/iStoreOS-Actions/releases/download/iStoreOS-24.10-${{ inputs.openwrt_rootfs }}-${{ inputs.network_settings }}/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: 🔍 查找rootfs.tar.gz所在路径
        id: find_rootfs
        run: |
          ROOTFS_FILE=$(find bin/targets/armsr/armv8/ -type f -name "*rootfs.tar.gz" | head -n1)
          echo "✅ Found: $ROOTFS_FILE"
          if [ ! -f "$ROOTFS_FILE" ]; then
            echo "❌ 找不到 rootfs.tar.gz 文件"
            exit 1
          fi
          echo "file=$ROOTFS_FILE" >> $GITHUB_OUTPUT

      - name: ⚙️ 添加RT28配置到打包环境
        run: |
          echo "添加RT28配置到打包环境..."
          
          # 创建临时目录结构
          mkdir -p custom_files/etc/board.d
          mkdir -p custom_files/etc/config
          
          # 创建RT28 LED配置文件
          cat > custom_files/etc/board.d/01_leds_rt28 << 'EOF'
          . /lib/functions.sh

          set_led_config() {
              case "$(board_name)" in
                  h96-max-m2)
                      # RT28专用LED配置
                      ucidef_set_led_netdev "wlan2g" "WiFi 2.4GHz" "link_blue" "radio0"
                      ucidef_set_led_netdev "wlan5g" "WiFi 5GHz" "link_green" "radio1"
                      ;;
              esac
          }

          boot_hook_add preinit_main set_led_config
          EOF

          # 创建RT28 network配置文件
          cat > custom_files/etc/config/network << 'EOF'
          config interface 'loopback'
              option ifname 'lo'
              option proto 'static'
              option ipaddr '127.0.0.1'
              option netmask '255.0.0.0'

          config globals 'globals'
              option ula_prefix 'fd00:ab:cd::/48'

          config interface 'lan'
              option type 'bridge'
              option ifname 'eth0.1'
              option proto 'static'
              option ipaddr '192.168.8.1'
              option netmask '255.255.255.0'
              option ip6assign '60'

          config interface 'wan'
              option ifname 'eth0.2'
              option proto 'dhcp'

          config switch
              option name 'switch0'
              option reset '1'
              option enable_vlan '1'

          config switch_vlan
              option device 'switch0'
              option vlan '1'
              option ports '0 1 2 7'

          config switch_vlan
              option device 'switch0'
              option vlan '2'
              option ports '3 7'
          EOF

          # 设置执行权限
          chmod +x custom_files/etc/board.d/01_leds_rt28

      - name: 🧱 打包iStoreOS固件（包含RT28配置）
        uses: sy3tem/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: ${{ steps.find_rootfs.outputs.file }}
          openwrt_board: ${{ inputs.openwrt_board }}
          openwrt_kernel: ${{ inputs.openwrt_kernel }}
          auto_kernel: true
          kernel_repo: ophub/kernel
          kernel_usage: stable
          builder_name: kwonelee
          custom_files: ./custom_files

      - name: 📜 调整.img.gz 文件名
        id: rename
        run: |
          for FILE in ${{ env.PACKAGED_OUTPUTPATH }}/*.img.gz; do
            echo "Processing file: $FILE"
            FILENAME=$(basename "$FILE")
            NEW_FILENAME=$(echo "$FILENAME" | sed 's/openwrt/istoreos_24.10.2/g' | sed 's/h96-max-m2/rt28-test/g')
            if [ "$FILENAME" != "$NEW_FILENAME" ]; then
              mv "$FILE" "${{ env.PACKAGED_OUTPUTPATH }}/$NEW_FILENAME"
              echo "Renamed $FILENAME to $NEW_FILENAME"
            else
              echo "No need to rename $FILENAME"
            fi
          done

      - name: 🚀 上传到 Release
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: iStoreOS-24.10-RT28-TEST-${{ inputs.openwrt_rootfs }}-${{ inputs.network_settings }}
          body: |
            📌 版本： iStoreOS-24.10.2-RELEASE (测试版)
            📟 基础设备： h96-max-m2 (适配RT28网络/LED)
            🏷️ 平台： armsr/armv8
            🧠 内核： ${{ inputs.openwrt_kernel }}
            
            🌐 RT28网络配置：
              - LAN: eth0.1 (IP: 192.168.8.1)
              - WAN: eth0.2 (DHCP)
              - 交换机: VLAN1 (LAN): 0,1,2,7; VLAN2 (WAN): 3,7
            
            💡 RT28 LED配置：
              - WiFi 2.4GHz: link_blue (radio0)
              - WiFi 5GHz: link_green (radio1)
            
            ⚠️ 注意：此为测试版本，基于h96-max-m2设备适配RT28的网络和LED配置
            
            👤 用户名： root
            🔒 密码： 无
            🌐 管理地址： 192.168.8.1
          files: |
            ${{ env.PACKAGED_OUTPUTPATH }}/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
